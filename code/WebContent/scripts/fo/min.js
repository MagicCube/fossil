/* Wed Sep 11 14:50:00 CST 2013 */
/* Generated by MagicCube MXBuild with MXFramework */
$ns("fo.ani");$import("fo.ani.Splash");$import("fo.ani.To2D");
fo.ani.Animation=function(){var a=$extend(MXComponent),b={};a.nextAnimation=null;a.view=null;a.camera=null;a.objects=null;a.duration=0;a.onstart=null;a.oncomplete=null;b.init=a.init;a.init=function(d){b.init(d);a.on("complete",a._oncomplete)};a.start=function(){TWEEN.removeAll();a.trigger("start")};a.chain=function(b){a.nextAnimation=b;return a.nextAnimation};a._oncomplete=function(){null!=a.nextAnimation&&a.nextAnimation.start();a.nextAnimation=null;a.view=null;a.camera=null;a.objects=null};return a.endOfClass(arguments)};
fo.ani.Animation.createInstance=function(a,b){return new fo.ani[a](b)};$ns("fo.ani");
fo.ani.Splash=function(){var a=$extend(fo.ani.Animation),b={};a.duration=8E3;a.range=6200;b.init=a.init;a.init=function(a){b.init(a)};b.start=a.start;a.start=function(){b.start();(new TWEEN.Tween(a.camera.position)).to({z:3800},0.5*a.duration).easing(TWEEN.Easing.Cubic.Out).start();(new TWEEN.Tween(a.rootObject.rotation)).to({y:2*Math.PI,x:2*Math.PI,z:2*Math.PI},24E4).easing(TWEEN.Easing.Sinusoidal.InOut).repeat(1E3).start();a.explode()};a.explode=function(){for(var b=0.7*a.duration,e=0;e<a.objects.length;e++)(new TWEEN.Tween(a.objects[e].position)).delay(Math.random()*
b/2+0.2*a.duration).to({x:Math.random()*a.range-a.range/2,y:Math.random()*a.range-a.range/2,z:Math.random()*a.range-a.range/2},b/2).easing(TWEEN.Easing.Exponential.InOut).start();setTimeout(function(){a.trigger("complete")},b)};return a.endOfClass(arguments)};$ns("fo.ani");
fo.ani.To2D=function(){function a(){b.view.switchTo2D();for(var a=0;a<b.objects.length;a++){var d=b.objects[a];d.element.style.top=d.element.style.top.replace("-","")}}var b=$extend(fo.ani.Animation),d={};b.duration=8E3;d.init=b.init;b.init=function(a){d.init(a)};d.start=b.start;b.start=function(){d.start();TWEEN.removeAll();for(var e=b.duration,k=b.view.$container.children(".taxon"),f=0;f<fo.taxons.length;f++){var c=fo.taxons[f],c={left:c.start+b.view.padding.left,width:c.end-c.start,height:18,top:19*
-f-b.view.padding.top,borderOpacity:0};if(f<b.objects.length){var g=b.objects[f];(new TWEEN.Tween(g.rotation)).delay(Math.random()*e/2).to({x:0,y:0,z:0},e/2).easing(TWEEN.Easing.Exponential.Out).start();(new TWEEN.Tween(g.position)).delay(Math.random()*e/3).to({x:0,y:0,z:0},2*(e/3)).easing(TWEEN.Easing.Exponential.Out).start();(new TWEEN.Tween({taxonDiv:g.element,taxonInnerDiv:g.element.childNodes[0],width:280,height:280,top:0,borderOpacity:0.2})).delay(Math.random()*e/3).to(c,2*(e/3)).easing(TWEEN.Easing.Exponential.Out).onUpdate(function(){this.taxonInnerDiv.style.borderRadius=
0;this.taxonDiv.style.top=this.top+"px";this.taxonInnerDiv.style.borderColor="rgba(255, 255, 255, "+this.borderOpacity+")";this.taxonInnerDiv.style.width=this.width+"px";this.taxonInnerDiv.style.height=this.height+"px";this.taxonInnerDiv.style.left=this.left+"px"}).onComplete(function(){this.taxonInnerDiv.style.border="none"}).start()}else g=k[f-b.objects.length].childNodes[0],g.style.width=c.width+"px",g.style.height=c.height+"px",g.style.left=c.left+"px"}(new TWEEN.Tween(b.rootObject.rotation)).to({x:0,
y:0,z:0},e).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(b.camera.rotation)).delay(Math.random()*e/2).to({x:0,y:0,z:0},e/2).easing(TWEEN.Easing.Exponential.InOut).start();k=704/(b.view.frame.width/b.view.frame.height/(16/9))*(b.view.frame.width/1920);(new TWEEN.Tween(b.camera.position)).to({x:b.view.frame.width/2,y:-b.view.frame.height/2,z:k},e).easing(TWEEN.Easing.Exponential.InOut).onComplete(function(){setTimeout(a,200)}).start()};return b.endOfClass(arguments)};$ns("fo");$import("lib.three.Three",function(){$import("lib.three.control.TrackballControls");$import("lib.three.renderer.CSS3DRenderer")});$import("lib.d3.D3");$import("lib.jquery.plugin.Transit");$import("lib.tween.Tween");$import("fo.view.SearchBoxView");$import("fo.scn.TaxonDetailScene");$import("fo.scn.DiversityScene");$import("fo.scn.OverviewScene");$import("fo.scn.WelcomeScene");$include("fo.res.App.css");
fo.App=function(){var a=$extend(mx.app.Application);a.appId="fo.App";a.appDisplayName="The Fossil Project";var b={};a.scenes=[];a.rootScene=null;a.activeScene=null;a.poppedScene=null;a.homeSceneName="Welcome";a.taxons=[];a.sections=[];var d=a.searchBoxView=null,e=null;b.init=a.init;a.init=function(d){a.frame={width:window.innerWidth,height:window.innerHeight};b.init(d);a.initBackground();a.initOverlay();a.loadTaxons();a.loadSections();a.initSearchBoxView();a.$container.on("mousewheel",function(a){a.preventDefault()})};
a.initBackground=function(){d=$("\x3cimg id\x3d'background' src\x3d'"+mx.getResourcePath("fo.res.images.background","jpg")+"'\x3e");a.$container.append(d)};a.initOverlay=function(){e=$("\x3cdiv id\x3d'overlay'/\x3e");e.on("click",function(b){b.target==e.get(0)&&a.hidePoppedScene()})};a.initSearchBoxView=function(){a.searchBoxView=new fo.view.SearchBoxView({frame:{left:0,top:0}});a.searchBoxView.hide();a.addSubview(a.searchBoxView)};a.loadTaxons=function(){$.ajax({url:$mappath("~/data/taxons.json"),
async:!1}).success(function(a){fo.taxons=[];for(var b=0;b<a.length;b++){var c=a[b];fo.taxons.add(c);fo.taxons[c.id]=c}})};a.loadSections=function(){$.ajax({url:$mappath("~/data/sections.json"),async:!1}).success(function(a){fo.sections=[];for(var b=0;b<a.length;b++){var c=a[b];fo.sections[c.id]=c;fo.sections.add(c)}})};b.run=a.run;a.run=function(b){a.setRootScene(a.homeSceneName,{taxon:fo.taxons[0],frame:{left:0,right:0}})};$(document).on("keydown",function(b){if(null!=a.activeScene&&isFunction(a.activeScene.onKeydown))a.activeScene.onKeydown(b)});
a.getScene=function(b,d){var c=a.scenes[b];if(null==c){var c=fo.scn[b+"Scene"],e=null;d&&(e={left:0,top:0,width:a.frame.width,height:a.frame.height});c=new c({id:b,frame:e});a.scenes[b]=c;a.scenes.add(c)}return c};a.setRootScene=function(b,d){var c=a.getScene(b,!0);null!=a.activeScene&&(a.activeScene.deactivate(),a.activeScene.$container.detach(),a.activeScene=null);c.$container.addClass("root");a.$container.append(c.$container);a.rootScene=c;a.activeScene=c;c.activate(d,!1)};a.popupScene=function(b,
d){var c=a.getScene(b);null!=a.activeScene&&(a.activeScene.deactivate(),a.activeScene=null);a.searchBoxView.$container.fadeOut();c.$container.addClass("popped");e.hide();a.$container.append(e);e.fadeIn();a.$container.append(c.$container);a.poppedScene=c;a.activeScene=c;c.activate(d,!1);c.$container.css({scale:1,opacity:0,left:(a.frame.width-c.frame.width)/2,top:(a.frame.height-c.frame.height)/2});c.$container.transit({opacity:1,width:c.frame.width,height:c.frame.height},400,"ease");return c};a.hidePoppedScene=
function(){if(null!=a.poppedScene){var b=a.poppedScene;e.fadeOut(function(){e.detach()});a.poppedScene.deactivate();a.poppedScene.$container.transit({opacity:0,scale:0.2},300,"ease",function(){b.$container.detach()});a.poppedScene.$container.removeClass("popped");a.poppedScene=null;a.activeScene=null;null!=a.rootScene&&(a.activateScene=a.rootScene,a.activateScene.activate({},!0));a.searchBoxView.$container.fadeIn()}};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.GlobeView3D");$include("fo.res.DiversityScene.css");
fo.scn.DiversityScene=function(){var a=$extend(mx.scn.Scene);a.title="";a.autoFillParent=!0;var b={};a.globeView=null;b.init=a.init;a.init=function(d){b.init(d);a.initGlobeView()};a.initGlobeView=function(){a.globeView=new fo.view.GlobeView3D({frame:{left:0,top:0,width:a.frame.width,height:a.frame.height}});a.addSubview(a.globeView);d3.tsv($mappath("~/data/section.txt"),function(b){for(var e=[],k=0;k<b.length;k++){var f=b[k];e.add({value:parseInt(f.id),location:{lng:parseFloat(f.lng),lat:parseFloat(f.lat)}})}console.log(e);
a.globeView.addData(e)})};b.activate=a.activate;a.activate=function(d,e){b.activate(d,e);e||($("#projectLogo").fadeIn(),a.globeView.startAnimation())};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.TaxonSeqView3D");$include("fo.res.OverviewScene.css");
fo.scn.OverviewScene=function(){var a=$extend(mx.scn.Scene);a.autoFillParent=!0;a.elementClass="OverviewScene";var b={};a.seqView=null;b.init=a.init;a.init=function(d){b.init(d);a.initSeqView()};a.initSeqView=function(){a.seqView=new fo.view.TaxonSeqView3D({frame:{left:0,top:0,width:a.frame.width,height:a.frame.height-0}});a.addSubview(a.seqView)};b.activate=a.activate;a.activate=function(a,d){b.activate(a,d);d||$("#projectLogo").fadeIn()};var d=!1;a.onKeydown=function(b){if(!d&&(13==b.keyCode||32==
b.keyCode))d=!0,a.seqView.startAnimation("To2D")};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.TaxonInfoView");$import("fo.view.DistributionCompositeView");$import("fo.view.PlayControlView");$include("fo.res.TaxonDetailScene.css");
fo.scn.TaxonDetailScene=function(){var a=$extend(mx.scn.Scene);a.elementClass="TaxonDetailScene";a.autoFillParent=!0;var b={};a.taxon=null;a.distributionView=null;a.playControlView=null;var d=a.infoView=null,e=null;b.init=a.init;a.init=function(d){var e=1280,c=720;e>fo.app.frame.width&&(e=fo.app.frame.width);c>fo.app.frame.height&&(c=fo.app.frame.height);a.frame={width:e,height:c};b.init(d);a.initTitle();a.initDimension();a.initInfoView();a.initPlayControlView();a.initDistributionView()};a.initTitle=
function(){d=$("\x3ch1 id\x3d'title'\x3e");a.$container.append(d)};a.initDimension=function(){e=$("\x3ch1 id\x3d'dimension'\x3e");a.$container.append(e)};a.initInfoView=function(){a.infoView=fo.view.TaxonInfoView({frame:{top:15,left:15}});a.addSubview(a.infoView)};a.initDistributionView=function(){a.distributionView=new fo.view.DistributionCompositeView({playControlView:a.playControlView,frame:{left:0,top:0,width:a.frame.width,height:a.frame.height}});a.addSubview(a.distributionView)};a.initPlayControlView=
function(){a.playControlView=new fo.view.PlayControlView({frame:{bottom:10,left:10,right:10}});a.addSubview(a.playControlView)};b.activate=a.activate;a.activate=function(d,e){b.activate(d,e);e||a.setTaxon(d.taxon)};b.deactivate=a.deactivate;a.deactivate=function(){b.deactivate();a.playControlView.pause()};a.setTaxon=function(b){a.taxon=b;d.text(a.taxon.title);a.infoView.setTaxon(a.taxon);a.playControlView.setRange([a.taxon.start,a.taxon.end])};a.onKeydown=function(b){if(27==b.keyCode)fo.app.hidePoppedScene();
else if(13==b.keyCode||32==b.keyCode)a.playControlView.togglePlay();else if(39==b.keyCode||40==b.keyCode)a.playControlView.pause(),a.playControlView.moveToNextFrame(),b.stopPropagation(),b.preventDefault();else if(37==b.keyCode||38==b.keyCode)a.playControlView.pause(),a.playControlView.moveToPreviousFrame(),b.stopPropagation(),b.preventDefault()};return a.endOfClass(arguments)};$ns("fo.scn");$include("fo.res.WelcomeScene.css");
fo.scn.WelcomeScene=function(){function a(){e=$("#intro");e.css({left:(b.frame.width-800)/2,top:0.35*(b.frame.height-e.height())});e.on("click",function(){b.start()});b.$container.append(e)}var b=$extend(mx.scn.Scene);b.autoFillParent=!0;b.elementClass="WelcomeScene";var d={},e=null;d.init=b.init;b.init=function(b){d.init(b);a()};d.activate=b.activate;b.activate=function(a,b){d.activate(a,b);b||(e.css({display:"block",opacity:0,webkitTransform:"scale(0.96)"}),e.transit({opacity:1,scale:1},2E3))};
b.start=function(){e.fadeOut(function(){e.remove();fo.app.setRootScene("Overview")})};b.onKeydown=function(a){(13==a.keyCode||32==a.keyCode)&&b.start()};return b.endOfClass(arguments)};$ns("fo.view");$import("fo.view.DistributionGlobeView3D");$import("fo.view.DistributionHeatmapView");$include("fo.res.DistributionCompositeView.css");
fo.view.DistributionCompositeView=function(){function a(a){if(null!=b.activeView){for(a=0;a<b.dataSet.length;a++)b.dataSet[a].value=Math.round(Math.random());b.activeView.updateDataSet()}}var b=$extend(mx.view.View);b.elementClass="DistributionCompositeView";var d={};b.dataSet=null;b.activeView=null;b.globeView=null;b.heatmapView=null;b.playControlView=null;d.init=b.init;b.init=function(a){d.init(a);b.initDataSet();null!=b.playControlView&&b.setPlayControlView(b.playControlView);b.switchView("heatmap")};
b.initDataSet=function(){b.dataSet=[];for(var a=0;a<fo.sections.length;a++){var d=fo.sections[a],f={location:d.location,value:0};b.dataSet[d.id]=f;b.dataSet.add(f)}};b.initGlobeView=function(){b.globeView=new fo.view.DistributionGlobeView3D({id:"globe",dataSet:b.dataSet,frame:{left:0,top:0,width:b.frame.width,height:b.frame.height}})};b.initHeatmapView=function(){var a=$("\x3cdiv id\x3d'map'/\x3e");$(document.body).append(a);b.heatmapView=new fo.view.DistributionHeatmapView({id:"map",$element:a,dataSet:b.dataSet,
frame:{left:0,right:0,width:b.frame.width,height:b.frame.height}})};b.setPlayControlView=function(d){null!=b.playControlView&&(b.playControlView.off("positionchanged",a),b.playControlView=null);null!=d&&(b.playControlView=d,b.playControlView.on("positionchanged",a))};b.switchView=function(a){null!=b.playControlView&&b.playControlView.pause();if(null!=b.activeView){var d=b.activeView;isFunction(d.deactivate)&&d.deactivate();d.$container.fadeOut(function(){b.removeSubview(d)})}"heatmap"==a?(null==b.heatmapView&&
b.initHeatmapView(),b.activeView=b.heatmapView):"globe"==a&&(null==b.globeView&&b.initGlobeView(),b.activeView=b.globeView);b.addSubview(b.activeView);isFunction(b.activeView.deactivate)&&b.activeView.activate()};b.toggleView=function(){b.activeView==b.heatmapView?b.switchView("globe"):b.switchView("heatmap")};return b.endOfClass(arguments)};$ns("fo.view");$import("fo.view.GlobeView3D");fo.view.DistributionGlobeView3D=function(){var a=$extend(fo.view.GlobeView3D);a.isAnimating=!0;a.antialias=!1;var b={};a.dataSet=null;b.init=a.init;a.init=function(a){b.init(a)};a.updateDataSet=function(){};return a.endOfClass(arguments)};$ns("fo.view");$import("fo.view.HeatmapView");fo.view.DistributionHeatmapView=function(){var a=$extend(fo.view.HeatmapView),b={};b.init=a.init;a.init=function(a){b.init(a)};a.updateDataSet=function(){a.heatmapLayer.setData(a.dataSet,1)};return a.endOfClass(arguments)};$ns("fo.view");$import("fo.view.View3D");$include("fo.res.GlobeView3D.css");
fo.view.GlobeView3D=function(){var a=$extend(fo.view.View3D);a.elementClass="GlobeView3D";a.isAnimating=!0;a.antialias=!1;var b={};a.sphereGeometry=null;a.earth=null;var d=a.points=null,e=null;b.init=a.init;a.init=function(a){b.init(a);d=new THREE.Geometry;a=new THREE.CubeGeometry(0.75,0.75,1,1,1,1,null,!1);for(var f=0;f<a.vertices.length;f++)a.vertices[f].z+=0.5;e=new THREE.Mesh(a)};a.initTrackballControl=function(){null==a.trackballControl&&(a.trackballControl=new THREE.TrackballControls(a.camera,
a.renderer.domElement),a.trackballControl.rotateSpeed=0.5,a.trackballControl.noRotateY=!0,a.trackballControl.addEventListener("change",function(){a.render()}))};a.initCamera=function(){a.camera=new THREE.PerspectiveCamera(45,a.frame.width/a.frame.height,0.1,1E4);a.camera.position.x=0;a.camera.position.y=0;a.camera.position.z=0};b.initObjects=a.initObjects;a.initObjects=function(){a.geometry=new THREE.IcosahedronGeometry(200,4);a.initEarth()};a.initEarth=function(){var b=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",
value:THREE.ImageUtils.loadTexture(mx.getResourcePath("fo.res.images.world","jpg"))}},vertexShader:"varying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\ngl_Position \x3d projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\nvNormal \x3d normalize( normalMatrix * normal );\nvUv \x3d uv;\n}",fragmentShader:"uniform sampler2D texture;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\nvec3 diffuse \x3d texture2D( texture, vUv ).xyz;\nfloat intensity \x3d 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );\nvec3 atmosphere \x3d vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );\ngl_FragColor \x3d vec4( diffuse + atmosphere, 1.0 );\n}"});
a.earth=new THREE.Mesh(a.geometry,b);a.earth.matrixAutoUpdate=!1;a.scene.add(a.earth)};a.render=function(){a.isRendering&&(a.trigger("rendering"),a.renderer.render(a.scene,a.camera))};a.startAnimation=function(){a.isAnimating=!0;a.loop();(new TWEEN.Tween(a.camera.position)).to({x:60,y:60,z:650},2500).easing(TWEEN.Easing.Exponential.Out).onUpdate(function(){a.camera.lookAt(a.scene.position);a.render()}).start();null==a.trackballControl&&a.initTrackballControl()};a.stopAnimation=function(){a.isAnimating=
!1};a.loop=function(){a.isAnimating&&(requestAnimationFrame(a.loop),TWEEN.update(),null!=a.trackballControl&&a.trackballControl.update())};a.addPoint=function(b,f,c){var g=(90-b.lat)*Math.PI/180;b=(180-b.lng)*Math.PI/180;e.position.x=200*Math.sin(g)*Math.cos(b);e.position.y=200*Math.cos(g);e.position.z=200*Math.sin(g)*Math.sin(b);e.lookAt(a.earth.position);e.scale.z=-f;e.updateMatrix();for(f=0;f<e.geometry.faces.length;f++)e.geometry.faces[f].color=c;THREE.GeometryUtils.merge(d,e)};a.addData=function(b){for(var e=
d3.max(b,function(a){return a.value}),c=0;c<b.length;c++){var g=b[c];a.addPoint(g.location,80*(g.value/e),a.colorScale(g.value/e))}a.points=new THREE.Mesh(d,new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,morphTargets:!1}));a.scene.add(a.points)};a.colorScale=function(a){var b=new THREE.Color;b.setHSV(0.6-0.5*a,1,1);return b};return a.endOfClass(arguments)};$ns("fo.view");$import("fo.view.MapView");$include("fo.res.HeatmapView.css");
fo.view.HeatmapView=function(){var a=$extend(fo.view.MapView);a.elementClass="HeatmapView";var b={};a.heatmapLayer=null;a.dataSet=null;b.init=a.init;a.init=function(a){b.init(a)};b.initLayers=a.initLayers;a.initLayers=function(){b.initLayers();a.initHeatmap()};a.initHeatmap=function(){a.heatmapLayer=L.TileLayer.heatmap({radius:{value:4,absolute:!1},opacity:0.8,gradient:{"0.2":"rgb(0,0,255)","0.4":"rgb(0,255,255)","0.6":"rgb(0,255,0)","0.75":"yellow","0.85":"rgb(255,0,0)"}});a.map.addLayer(a.heatmapLayer)};
a.setDataSet=function(b,e){a.dataSet=b;a.heatmapLayer.setData(a.dataSet,e)};return a.endOfClass(arguments)};$ns("fo.view");$import("lib.quadtree.QuadTree");$import("lib.heatmap.Heatmap");$import("lib.leaflet.Leaflet",function(){$import("lib.leaflet.plugin.Heatmap");$import("lib.leaflet.plugin.Mapbox")});$include("lib.leaflet.leaflet.css");$include("lib.leaflet.plugin.mapbox.css");$include("fo.res.MapView.css");
fo.view.MapView=function(){var a=$extend(mx.view.View),b={};a.map=null;a.$map=null;a.mapElement=null;a.baseTileUrl="https://tiles.mapbox.com/v3/henryli.map-ccti13xw/{z}/{x}/{y}.png";a.defaultZoom=4;a.defaultLocation={lat:25,lng:132};a.layers=[];a.layerSwitcher=null;b.init=a.init;a.init=function(d){b.init(d);a.$element.addClass("MapView");a.$map=new $("\x3cdiv class\x3dLmap\x3e");a.mapElement=a.$map.get(0);a.$element.append(a.$map);a.initMap()};a.initMap=function(){a.map=L.mapbox.map(a.mapElement,
"henryli.map-ccti13xw",{minZoom:3,maxZoom:10,zoomControl:!1,attributionControl:!1});window.Lmap=a.map;a.initLayers();a.zoomToDefault()};a.initLayers=function(){};a.addLayer=function(b,e,k,f,c){a.layers.add(b);a.layers[e]=b;!1!=f&&a.map.addLayer(b)};a.removeLayer=function(b){isString(b)&&(b=a.layers[b]);a.map.removeLayer(b);a.layers.remove(b)};a.zoomTo=function(b,e){a.map.setView(b,e)};a.zoomToDefault=function(){a.zoomTo(a.defaultLocation,a.defaultZoom)};return a.endOfClass(arguments)};$ns("fo.view");$include("fo.res.PlayControlView.css");
fo.view.PlayControlView=function(){function a(){"playing"==c.playState&&(requestAnimationFrame(a),c.onFraming())}function b(a){c.togglePlay()}function d(a){$(document.body).css({webkitUserSelect:"none"});$(document.body).on("mousemove",e);$(document.body).on("mouseup",k)}function e(a){a=f(a);c.setPositionPercentage(a)}function k(a){a=f(a);c.setPositionPercentage(a);$(document.body).css({webkitUserSelect:""});$(document.body).off("mousemove",e);$(document.body).off("mouseup",k)}function f(a){var b=
m.position().left+c.$container.position().left+c.$container.parent().position().left;return(a.pageX-b-15)/(m.width()-15)}var c=$extend(mx.view.View);c.elementClass="PlayControlView";var g={};c.playState=null;c.position=0;c.positionPercentage=0;c.range=[0,100];c.onplaystatechanged=null;var h=c.onpositionchanged=null,l=null,m=null,q=null,n=null,p=null;g.init=c.init;c.init=function(a){g.init(a);h=$("\x3cdiv id\x3d'label'/\x3e");c.$container.append(h);l=$("\x3cdiv id\x3dplayPause/\x3e");l.on("click",
b);c.$container.append(l);m=$("\x3cdiv id\x3dprogressBar\x3e\x3cdiv id\x3dcursor\x3e\x3c/div\x3e\x3c/div\x3e");m.on("mousedown",d);q=m.children("#cursor");c.$container.append(m);n=$("\x3cdiv id\x3d'start' class\x3d'range'/\x3e");p=$("\x3cdiv id\x3d'end' class\x3d'range'/\x3e");c.$container.append(n);c.$container.append(p);c.setRange(c.range);c.pause()};c.play=function(){var b=c.setPlayState("playing");b&&(c.position>=c.range[1]&&c.setPosition(c.range[0]),a());return b};c.pause=function(){return c.setPlayState("paused")};
c.togglePlay=function(){"playing"==c.playState?c.pause():"paused"==c.playState&&c.play()};c.setPlayState=function(a){if(c.playState==a)return!1;c.playState=a;"playing"==c.playState?c.$container.addClass("playing").removeClass("paused"):"paused"==c.playState&&c.$container.addClass("paused").removeClass("playing");c.trigger("playstatechanged");return!0};c.setRange=function(a){c.pause();c.range=a;n.text(c.range[0]);p.text(c.range[1]);c.setPosition(c.range[0],!0)};c.setPosition=function(a,b){a>c.range[1]?
a=c.range[1]:a<c.range[0]&&(a=c.range[0]);if(c.position!=a||b)c.position=a,c.positionPercentage=(c.position-c.range[0])/(c.range[1]-c.range[0]),c.update(),h.text("#"+c.position),c.trigger("positionchanged");return c.position};c.setPositionPercentage=function(a){c.setPosition(Math.round(a*(c.range[1]-c.range[0])+c.range[0]))};c.update=function(){h.text(c.position);q.css({width:(m.width()-15)*c.positionPercentage+15})};c.moveToNextFrame=function(){c.setPosition(c.position+1,!0)};c.moveToPreviousFrame=
function(){c.setPosition(c.position-1,!0)};c.onFraming=function(){c.position>=c.range[1]?c.pause():c.moveToNextFrame()};return c.endOfClass(arguments)};$ns("fo.view");$include("fo.res.SearchBoxView.css");
fo.view.SearchBoxView=function(){function a(){null!=h&&(clearTimeout(h),h=null);h=setTimeout(b,800)}function b(a){f.text!=g.val()&&(f.text=g.val(),f.trigger("changed"),null!=f.delegate&&isFunction(f.delegate.search)&&f.delegate.search(f.text,f))}function d(b){48<=b.keyCode&&90>=b.keyCode&&(g.val(""),g.focus(),$(document.body).off("keydown",d),a())}function e(b){a();27==b.keyCode&&(""!=g.val()?g.val(""):g.blur())}function k(a){$(document.body).on("keydown",d)}var f=$extend(mx.view.View);f.elementClass=
"SearchBoxView";f.frame={width:550};var c={};f.text="";f.delegate=null;var g=f.onchanged=null;c.init=f.init;f.init=function(a){c.init(a);f.$container.append("\x3cdiv id\x3d'head'/\x3e\x3cdiv id\x3d'body'/\x3e\x3cdiv id\x3d'tail'/\x3e\x3cinput/\x3e");g=f.$container.children("input");g.on("keydown",e);g.on("blur",k);$(document.body).on("keydown",d)};var h=null;return f.endOfClass(arguments)};$ns("fo.view");$include("fo.res.TaxonInfoView.css");
fo.view.TaxonInfoView=function(){var a=$extend(mx.view.View);a.elementClass="TaxonInfoView";var b={},d=a.taxon=null,e=null;b.init=a.init;a.init=function(k){b.init(k);d=$("\x3ch1 id\x3d'name'\x3eSchizolus dubiiformis\x3c/h1\x3e");a.$container.append(d);e=$("\x3cdiv id\x3d'detailList'/\x3e");e.append("\x3cdl\x3e\x3cdt\x3eRank:\x3c/dt\x3e \x3cdd id\x3d'rank'\x3e#1\x3c/dd\x3e\x3c/dl\x3e");e.append("\x3cdl\x3e\x3cdt\x3eClass:\x3c/dt\x3e \x3cdd id\x3d'cls'\x3eBivalvia\x3c/dd\x3e\x3c/dl\x3e");e.append("\x3cdl\x3e\x3cdt\x3eGenus:\x3c/dt\x3e \x3cdd id\x3d'genus'\x3ePalaeoneilo\x3c/dd\x3e\x3c/dl\x3e");
e.append("\x3cdl\x3e\x3cdt\x3eAuthor:\x3c/dt\x3e \x3cdd id\x3d'author'\x3eLi Xin\x3c/dd\x3e\x3c/dl\x3e");a.$container.append(e)};a.setTaxon=function(b){a.taxon=b;b={name:b.fullName,rank:"#"+(fo.taxons.indexOf(b)+1),cls:b.cls,genus:b.genus,author:b.author+"("+b.year+")"};for(var d in b){var c=b[d];a.$container.find("#"+d).text(c?c:"N/A")}};return a.endOfClass(arguments)};$ns("fo.view");$import("fo.view.View3D");$import("fo.ani.Animation");$include("fo.res.TaxonSeqView.css");$include("fo.res.TaxonSeqView3D.css");
fo.view.TaxonSeqView3D=function(){function a(a){a=fo.taxons[this.id];fo.app.popupScene("TaxonDetail",{taxon:a,title:a.fullName})}function b(a){if(a.shiftKey){a.preventDefault();var b=d.scale+a.originalEvent.wheelDelta/1E3;1<b?b=1:0.1>b&&(b=0.1);d.setScale(b)}else 0<a.originalEvent.wheelDeltaX&&0==d.$scene.get(0).scrollLeft&&a.preventDefault();a.stopPropagation()}var d=$extend(fo.view.View3D);d.elementClass="TaxonSeqView";d.renderingMode="css";var e={};d.mode="2D";d.scale=1;d.padding={top:75,left:25,
right:25};d.rootObject=null;d.$scene=null;d.$camera=null;d.styleSheet=null;e.init=d.init;d.init=function(a){e.init(a);d.startAnimation("Splash");for(a=a=0;a<document.styleSheets.length&&!document.styleSheets[a].href.contains("TaxonSeqView.css");a++);d.styleSheet=document.styleSheets[a]};e.initScene=d.initScene;d.initScene=function(){d.switchTo3D();"fast"==$speed&&setTimeout(function(){d.startAnimation("To2D")},50);e.initScene()};e.initCamera=d.initCamera;d.initCamera=function(){e.initCamera();d.camera.position.z=
0};d.initTaxons=function(){var a=d3.select(d.$container.get(0)).selectAll(".taxon").data(fo.taxons).enter().append("div").classed("taxon",!0).attr({id:function(a){return a.id}}).append("div").style({"background-color":function(){return"rgba(123, 29, 32, "+(0.4+0.5*Math.random())+")"}});a.append("span").attr("id","name").text(function(a){return a.name});a.append("span").attr("id","fullName").text(function(a){return a.fullName})};d.initObjects=function(){d.initTaxons();d.rootObject=new THREE.Object3D;
for(var a=new THREE.Vector3,b=d.$container.find(".taxon"),c=0;500>c;c++){var e=b.get(c),e=new THREE.CSS3DObject(e),h=Math.acos(-1+2*c/500),l=Math.sqrt(500*Math.PI)*h;e.position.x=1750*Math.cos(l)*Math.sin(h);e.position.y=1750*Math.sin(l)*Math.sin(h);e.position.z=1750*Math.cos(h);a.copy(e.position).multiplyScalar(2);e.lookAt(a);d.objects.add(e);d.rootObject.add(e)}d.scene.add(d.rootObject)};e.startAnimation=d.startAnimation;d.startAnimation=function(a,b){var c=null,c=fo.ani.Animation.createInstance(a,
{camera:d.camera,scene:d.scene,rootObject:d.rootObject,objects:d.objects,view:d});null!=c&&("fast"==$speed?c.duration*=0.05:"slow"==$speed&&(c.duration*=1.5),c.start());e.startAnimation();return c};d.switchTo3D=function(){d.mode="3D";d.$container.removeClass("two-d");d.$container.addClass("three-d")};d.switchTo2D=function(){d.stopAnimation();d.isRendering=!1;d.mode="2D";fo.app.searchBoxView.$container.delay(600).fadeIn("slow");d.$container.append("\x3cdiv id\x3d'topShadow' class\x3d'shadow'/\x3e\x3cdiv id\x3d'bottomShadow' class\x3d'shadow'/\x3e");
d.$container.find(".shadow").hide().fadeIn(5E3);d.$container.find(".camera").css({transform:"",webkitTransformStyle:"",webkitPerspective:""});d.$container.find(".scene").css({transform:"",webkitTransformStyle:"",webkitPerspective:""});d.$container.find(".taxon").css({transform:"",webkitTransformStyle:"",top:"",position:""});d.$container.find(".taxon div").css({height:"",border:"",borderRadius:""});d.$scene=d.$container.find(".scene");d.$scene.css({width:"",height:""});d.$camera=d.$container.find(".camera");
d.$camera.css({"-webkit-transform-origin-x":"","-webkit-transform-origin-y":"",width:"",height:""});d.$container.addClass("two-d");d.$container.removeClass("three-d");d.$camera.append(d.$container.children(".taxon"));d.$camera.append("\x3cdiv id\x3dplaceHolder/\x3e");TWEEN.removeAll();fo.app.searchBoxView.delegate=d;d.$scene.css("overflow","auto").on("mousewheel",b);d.$scene.on("click",".taxon",a)};d.search=function(a,b){d.setScale(1);var c=a.trim().toLowerCase();d.$scene.scrollTop(0);for(var e=0;e<
fo.taxons.length;e++){var h=fo.taxons[e],l=d.$container.find(".taxon#"+h.id);h.fullName.toLowerCase().startsWith(c)?l.show():l.hide()}};d.setScale=function(a){d.scale!=a&&(d.scale=a,a=parseInt(18*d.scale),d.styleSheet.rules[3].style.height=a+"px",d.styleSheet.rules[5].style.display=0.8<=d.scale?"":"none")};return d.endOfClass(arguments)};$ns("fo.view");
fo.view.View3D=function(){var a=$extend(mx.view.View);a.elementClass="View3D";var b={};a.isRendering=!0;a.isAnimating=!1;a.antialias=!1;a.scene=null;a.camera=null;a.renderer=null;a.renderingMode="webgl";a.rendererClass=THREE.WebGLRenderer;a.trackballControl=null;a.objects=[];a.onrendering=null;b.init=a.init;a.init=function(d){b.init(d);a.initScene();a.initCamera();a.initRenderer()};a.initScene=function(){a.scene=new THREE.Scene;a.initObjects()};a.initObjects=function(){};a.initRenderer=function(){a.rendererClass=
"css"==a.renderingMode?THREE.CSS3DRenderer:"canvas"==a.renderingMode?THREE.CanvasRenderer:THREE.WebGLRenderer;a.renderer=new a.rendererClass({antialias:a.antialias});a.renderer.setSize(a.frame.width,a.frame.height);a.$element.get(0).appendChild(a.renderer.domElement)};a.initCamera=function(){a.camera=new THREE.PerspectiveCamera(75,a.frame.width/a.frame.height,150,1E3)};a.initTrackballControl=function(){null==a.trackballControl&&(a.trackballControl=new THREE.TrackballControls(a.camera,a.renderer.domElement),
a.trackballControl.rotateSpeed=0.5,a.on("rendering",function(){a.trackballControl.update()}))};a.render=function(){a.isAnimating&&requestAnimationFrame(a.render);a.isRendering&&a.trigger("rendering");TWEEN.update();a.isRendering&&a.renderer.render(a.scene,a.camera)};a.startAnimation=function(){a.isAnimating=!0;a.render()};a.stopAnimation=function(){a.isAnimating=!1};return a.endOfClass(arguments)};