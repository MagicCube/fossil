/* Thu Sep 05 15:49:53 CST 2013 */
/* Generated by MagicCube MXBuild with MXFramework */
$ns("fo.ani");$import("fo.ani.Explosion");$import("fo.ani.Splash");fo.ani.Animation=function(){var a=$extend(MXComponent),b={};a.nextAnimation=null;a.camera=null;a.objects=null;a.duration=0;a.onstart=null;a.oncomplete=null;b.init=a.init;a.init=function(c){b.init(c);a.on("complete",a._oncomplete)};a.start=function(){TWEEN.removeAll();a.trigger("start")};a.chain=function(b){a.nextAnimation=b;return a.nextAnimation};a._oncomplete=function(){null!=a.nextAnimation&&a.nextAnimation.start()};return a.endOfClass(arguments)};
fo.ani.Animation.createInstance=function(a,b){return new fo.ani[a](b)};$ns("fo.ani");
fo.ani.Explosion=function(){var a=$extend(fo.ani.Animation),b={};a.duration=8E3;a.range=6E3;b.init=a.init;a.init=function(a){b.init(a)};b.start=a.start;a.start=function(){b.start();(new TWEEN.Tween(a.camera.position)).to({x:-4500,z:1800,y:2E3},12E4).easing(TWEEN.Easing.Sinusoidal.InOut).start();a.explode()};a.explode=function(){for(var b=0.8*a.duration,e=0;e<a.objects.length;e++)(new TWEEN.Tween(a.objects[e].position)).delay(Math.random()*b/2).to({x:Math.random()*a.range-a.range/2,y:Math.random()*a.range-
a.range/2,z:Math.random()*a.range-a.range/2},b/2).easing(TWEEN.Easing.Exponential.InOut).start();setTimeout(function(){a.trigger("complete")},b)};return a.endOfClass(arguments)};$ns("fo.ani");
fo.ani.Splash=function(){var a=$extend(fo.ani.Animation),b={};a.duration=8E3;a.range=6500;b.init=a.init;a.init=function(a){b.init(a)};b.start=a.start;a.start=function(){b.start();(new TWEEN.Tween(a.camera.position)).to({z:3800},0.4*a.duration).easing(TWEEN.Easing.Cubic.Out).start();var c=(new TWEEN.Tween(a.camera.position)).to({x:-4600,z:1800,y:2E3},12E4).easing(TWEEN.Easing.Sinusoidal.InOut).yoyo(!0).repeat(1E3);setTimeout(function(){c.start()},0.3*a.duration);setTimeout(a.explode,0.2*a.duration)};
a.explode=function(){for(var b=0.8*a.duration,e=0;e<a.objects.length;e++)(new TWEEN.Tween(a.objects[e].position)).delay(Math.random()*b/2).to({x:Math.random()*a.range-a.range/2,y:Math.random()*a.range-a.range/2,z:Math.random()*a.range-a.range/2},b/2).easing(TWEEN.Easing.Exponential.InOut).start();setTimeout(function(){a.trigger("complete")},b)};return a.endOfClass(arguments)};$ns("fo");$import("lib.three.Three",function(){$import("lib.three.control.TrackballControls");$import("lib.three.renderer.CSS3DRenderer");$import("lib.globe.Globe")});$import("lib.d3.D3");$import("lib.jquery.plugin.Transit");$import("lib.tween.Tween");$import("fo.view.SearchBoxView");$import("fo.scn.DiversityScene");$import("fo.scn.OverviewScene");$import("fo.scn.WelcomeScene");$include("fo.res.App.css");
fo.App=function(){var a=$extend(mx.app.Application);a.appId="fo.App";a.appDisplayName="The Fossil Project";var b={};a.scenes=[];a.activeScene=null;var c=a.searchBoxView=null;b.init=a.init;a.init=function(e){b.init(e);a.initBackground();a.loadTaxons();a.initSearchBoxView();a.$container.on("mousewheel",function(a){a.preventDefault()})};a.initBackground=function(){c=$("\x3cimg id\x3d'background' src\x3d'"+mx.getResourcePath("fo.res.images.background","jpg")+"'\x3e");a.$container.append(c)};a.initSearchBoxView=
function(){a.searchBoxView=new fo.view.SearchBoxView({frame:{left:0,top:0}});a.searchBoxView.hide();a.addSubview(a.searchBoxView)};a.loadTaxons=function(){$.ajax({url:$mappath("~/data/taxon.dic"),async:!1}).success(function(a){window.fo.taxons=[];a=a.split("\n");for(var b=0;1200>b;b++){var d=a[b],d={id:d.substr(0,10),name:d.substr(17,8)};fo.taxons.add(d)}})};b.run=a.run;a.run=function(b){a.setRootScene("Welcome")};a.getScene=function(b){var f=a.scenes[b];null==f&&(f=new fo.scn[b+"Scene"]({id:b,frame:{left:0,
top:0,width:window.innerWidth,height:window.innerHeight}}),a.scenes[b]=f,a.scenes.add(f));return f};a.setRootScene=function(b,f){var d=a.getScene(b);null!=a.activeScene&&(a.activeScene.deactivate(),a.activeScene.$container.detach(),a.activeScene=null);a.$container.append(d.$container);a.activeScene=d;d.activate(f,!1)};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.GlobeView3D");$include("fo.res.DiversityScene.css");
fo.scn.DiversityScene=function(){var a=$extend(mx.scn.Scene);a.title="";a.autoFillParent=!0;var b={};a.globeView=null;b.init=a.init;a.init=function(c){b.init(c);a.initGlobeView()};a.initGlobeView=function(){a.globeView=new fo.view.GlobeView3D({frame:{left:0,top:0,width:a.frame.width,height:a.frame.height}});a.addSubview(a.globeView)};b.activate=a.activate;a.activate=function(c,e){b.activate(c,e);e||($("#projectLogo").fadeIn(),a.globeView.startAnimate())};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.TaxonSeqChartView");$include("fo.res.OverviewScene.css");
fo.scn.OverviewScene=function(){var a=$extend(mx.scn.Scene);a.autoFillParent=!0;a.elementClass="OverviewScene";var b={};a.chartView=null;b.init=a.init;a.init=function(c){b.init(c);a.initChartView()};a.initChartView=function(){a.chartView=new fo.view.TaxonSeqChartView({frame:{left:0,top:0,width:a.frame.width,height:a.frame.height-0}});a.addSubview(a.chartView)};b.activate=a.activate;a.activate=function(a,e){b.activate(a,e);e||$("#projectLogo").fadeIn()};return a.endOfClass(arguments)};$ns("fo.scn");$import("fo.view.TaxonChaosView3D");$include("fo.res.WelcomeScene.css");
fo.scn.WelcomeScene=function(){function a(){e=$("#intro");e.css({left:(b.frame.width-800)/2,top:0.35*(b.frame.height-e.height())});e.on("click",function(){b.start()});b.$container.append(e)}var b=$extend(mx.scn.Scene);b.autoFillParent=!0;b.elementClass="WelcomeScene";var c={},e=b.taxonChaosView3D=null;c.init=b.init;b.init=function(f){c.init(f);a();b.initTaxonView()};b.initTaxonView=function(){b.taxonView=new fo.view.TaxonChaosView3D({frame:{left:0,right:0,width:b.frame.width,height:b.frame.height}})};
c.activate=b.activate;b.activate=function(a,d){c.activate(a,d);d||($debug||(e.css({display:"block",opacity:0,webkitTransform:"scale(0.96)"}),e.transit({opacity:1,scale:1},2E3)),$debug&&b.start())};c.deactivate=b.deactivate;b.deactivate=function(){c.deactivate();fo.app.searchBoxView.delegate=null};b.start=function(){e.fadeOut(function(){$("#projectLogo").fadeIn("slow");e.remove();b.addSubview(b.taxonView);b.taxonView.startAnimate("Splash").on("complete",function(){$debug?fo.app.searchBoxView.show():
fo.app.searchBoxView.$container.fadeIn(1500);fo.app.searchBoxView.delegate=b.taxonView})})};return b.endOfClass(arguments)};$ns("fo.view");$import("fo.view.View3D");$include("fo.res.GlobeView3D.css");
fo.view.GlobeView3D=function(){var a=$extend(fo.view.View3D);a.elementClass="GlobeView3D";a.isAnimating=!0;var b={};a.sphereGeometry=null;a.earth=null;var c=a.points=null,e=null;THREE.Color.prototype.setHSV=function(a,b,e){var c,k,l,n,p,m;if(0==e)c=k=l=0;else switch(n=Math.floor(6*a),p=6*a-n,a=e*(1-b),m=e*(1-b*p),b=e*(1-b*(1-p)),n){case 1:c=m;k=e;l=a;break;case 2:c=a;k=e;l=b;break;case 3:c=a;k=m;l=e;break;case 4:c=b;k=a;l=e;break;case 5:c=e;k=a;l=m;break;case 6:case 0:c=e,k=b,l=a}this.r=c;this.g=
k;this.b=l;this.autoUpdate&&(this.updateHex(),this.updateStyleString())};b.init=a.init;a.init=function(f){b.init(f);c=new THREE.Geometry;f=new THREE.CubeGeometry(0.75,0.75,1,1,1,1,null,!1);for(var d=0;d<f.vertices.length;d++)f.vertices[d].z+=0.5;e=new THREE.Mesh(f);a.addPoint({lng:118,lat:32},20,a.colorScale(0.1));a.points=new THREE.Mesh(c,new THREE.MeshBasicMaterial({color:16777215,vertexColors:THREE.FaceColors,morphTargets:!1}));a.scene.add(a.points)};a.initCamera=function(){a.camera=new THREE.PerspectiveCamera(45,
a.frame.width/a.frame.height,0.1,1E4);a.camera.position.z=650};b.initObjects=a.initObjects;a.initObjects=function(){a.geometry=new THREE.SphereGeometry(200,40,30);a.initEarth()};a.initEarth=function(){var b=new THREE.ShaderMaterial({uniforms:{texture:{type:"t",value:THREE.ImageUtils.loadTexture(mx.getResourcePath("fo.res.images.world","jpg"))}},vertexShader:"varying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\ngl_Position \x3d projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\nvNormal \x3d normalize( normalMatrix * normal );\nvUv \x3d uv;\n}",
fragmentShader:"uniform sampler2D texture;\nvarying vec3 vNormal;\nvarying vec2 vUv;\nvoid main() {\nvec3 diffuse \x3d texture2D( texture, vUv ).xyz;\nfloat intensity \x3d 1.05 - dot( vNormal, vec3( 0.0, 0.0, 1.0 ) );\nvec3 atmosphere \x3d vec3( 1.0, 1.0, 1.0 ) * pow( intensity, 3.0 );\ngl_FragColor \x3d vec4( diffuse + atmosphere, 1.0 );\n}"});a.earth=new THREE.Mesh(a.geometry,b);a.scene.add(a.earth)};b.startAnimate=a.startAnimate;a.startAnimate=function(){b.startAnimate();null==a.trackballControl&&
a.initTrackballControl()};a.addPoint=function(b,d,g){var h=(90-b.lat)*Math.PI/180;b=-b.lng*Math.PI/180;e.position.x=200*Math.sin(h)*Math.cos(b);e.position.y=200*Math.cos(h);e.position.z=200*Math.sin(h)*Math.sin(b);e.lookAt(a.earth.position);e.scale.z=-d;e.updateMatrix();for(d=0;d<e.geometry.faces.length;d++)e.geometry.faces[d].color=g;THREE.GeometryUtils.merge(c,e)};a.colorScale=function(a){var b=new THREE.Color;b.setHSL(0.6-0.5*a,1,1);return b};return a.endOfClass(arguments)};$ns("fo.view");$include("fo.res.SearchBoxView.css");
fo.view.SearchBoxView=function(){function a(){null!=k&&(clearTimeout(k),k=null);k=setTimeout(b,800)}function b(a){d.text!=h.val()&&(d.text=h.val(),d.trigger("changed"),null!=d.delegate&&isFunction(d.delegate.search)&&d.delegate.search(d.text,d))}function c(b){48<=b.keyCode&&90>=b.keyCode&&(h.val(""),h.focus(),$(document.body).off("keydown",c),a())}function e(b){a();27==b.keyCode&&(""!=h.val()?h.val(""):h.blur())}function f(a){$(document.body).on("keydown",c)}var d=$extend(mx.view.View);d.elementClass=
"SearchBoxView";d.frame={width:550};var g={};d.text="";d.delegate=null;var h=d.onchanged=null;g.init=d.init;d.init=function(a){g.init(a);d.$container.append("\x3cdiv id\x3d'head'/\x3e\x3cdiv id\x3d'body'/\x3e\x3cdiv id\x3d'tail'/\x3e\x3cinput/\x3e");h=d.$container.children("input");h.on("keydown",e);h.on("blur",f);$(document.body).on("keydown",c)};var k=null;return d.endOfClass(arguments)};$ns("fo.view");$import("fo.view.View3D");$import("fo.ani.Animation");$include("fo.res.TaxonChaosView3D.css");
fo.view.TaxonChaosView3D=function(){function a(){}var b=$extend(fo.view.View3D);b.elementClass="TaxonChaosView3D";b.renderingMode="css";b.isAnimating=!0;var c={};b.objects=[];b.root=null;c.init=b.init;b.init=function(e){c.init(e);b.on("rendering",a)};b.initObjects=function(){b.root=new THREE.Object3D;for(var a=new THREE.Vector3,c=0;600>c;c++){var d=fo.taxons[c],g=$("\x3cdiv class\x3d'taxon'\x3e");g.css("backgroundColor","rgba(123, 29, 32, "+(0.4+0.5*Math.random())+")");g.text(d.name.replace(".1111",
""));g=new THREE.CSS3DObject(g.get(0));g.taxon=d;var d=Math.acos(-1+2*c/600),h=Math.sqrt(600*Math.PI)*d;g.position.x=2100*Math.cos(h)*Math.sin(d);g.position.y=2100*Math.sin(h)*Math.sin(d);g.position.z=2100*Math.cos(d);a.copy(g.position).multiplyScalar(2);g.lookAt(a);b.root.add(g);b.objects.add(g)}b.scene.add(b.root)};c.initCamera=b.initCamera;b.initCamera=function(){c.initCamera();b.camera.position.z=0};c.startAnimate=b.startAnimate;b.startAnimate=function(a){null==b.trackballControl&&setTimeout(function(){b.initTrackballControl()},
1E3);var f=null;"Splash"==a?(f=fo.ani.Animation.createInstance(a,{camera:b.camera,objects:b.objects,duration:$debug?100:1E4}),f.start()):"Explosion"==a&&(f=fo.ani.Animation.createInstance(a,{camera:b.camera,objects:b.objects,duration:5E3}),f.start());c.startAnimate();return f};b.search=function(a){if(""==a)b.startAnimate("Explosion");else{TWEEN.removeAll();for(var c=[],d=0;d<b.objects.length;d++){var g=b.objects[d];g.taxon.name.toLowerCase().startsWith(a)?c.add(g):(new TWEEN.Tween(g.position)).delay(3E3*
Math.random()/2).to({z:1E4},1500).easing(TWEEN.Easing.Exponential.InOut).start()}c.sort(function(a,b){return a.taxon.name.localeCompare(b.taxon.name)});a=Math.ceil(c.length/15);for(d=0;d<c.length;d++){var g=c[d],h=d%15-7.5,k=Math.floor(d/15)-a/2;(new TWEEN.Tween(g.position)).delay(3E3*Math.random()/2).to({x:300*h,y:300*-k,z:0},1500).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(g.rotation)).delay(3E3*Math.random()/2).to({x:0,y:0,z:0},1500).easing(TWEEN.Easing.Exponential.InOut).start()}(new TWEEN.Tween(b.camera.position)).to({x:0,
y:0,z:2500},3E3).easing(TWEEN.Easing.Exponential.InOut).start();(new TWEEN.Tween(b.camera.rotation)).to({x:0,y:0,z:0},3E3).easing(TWEEN.Easing.Exponential.InOut).start()}};return b.endOfClass(arguments)};$ns("fo.view");$include("fo.res.TaxonSeqChartView.css");
fo.view.TaxonSeqChartView=function(){var a=$extend(mx.view.View);a.elementClass="TaxonSeqChartView";var b={};a.data=null;a.svg=null;a.svgRootGroup=null;a.scrollTop=0;b.init=a.init;a.init=function(c){b.init(c);a.svg=d3.select(a.$container.get(0)).append("svg").attr("width",a.frame.width).attr("height",a.frame.height);a.svgRootGroup=a.svg.append("g");a.$container.append(a.svg[0]);a.svg.on("mousewheel",function(){a.scrollTop+=-d3.event.wheelDelta/10;var b=a.svgRootGroup.node().getBoundingClientRect().height-
a.frame.height;0>a.scrollTop?a.scrollTop=0:a.scrollTop>b&&(a.scrollTop=b);a.svgRootGroup.attr("transform","translate(0, "+-a.scrollTop+")")});$data=c=[];for(var e=0;1200>e;e++){var f=parseInt(2380*Math.random()),d=f+parseInt(Math.random()*(2400-f)/4);c.add({name:fo.taxons[e].name,start:f,end:d})}a.setData(c)};a.setData=function(b){a.data=b;a.data.sort(function(a,b){return d3.ascending(a.start,b.start)});var e=d3.scale.linear();e.domain([0,2*a.data.length]).range([50,a.frame.width-100]);a.svgRootGroup.selectAll("rect.taxon").data(a.data).enter().append("rect").classed("taxon",
!0).attr("height",5).attr("x",function(a){return e(a.start)}).attr("width",function(a){return e(a.end-a.start)}).attr("y",function(a,b){return 8*b})};return a.endOfClass(arguments)};$ns("fo.view");
fo.view.View3D=function(){var a=$extend(mx.view.View);a.elementClass="View3D";var b={};a.isAnimating=!1;a.scene=null;a.camera=null;a.renderer=null;a.renderingMode="webgl";a.rendererClass=THREE.WebGLRenderer;a.trackballControl=null;a.onrendering=null;b.init=a.init;a.init=function(c){b.init(c);a.initScene();a.initCamera();a.initRenderer()};a.initScene=function(){a.scene=new THREE.Scene;a.initObjects()};a.initObjects=function(){};a.initRenderer=function(){a.rendererClass="css"==a.renderingMode?THREE.CSS3DRenderer:
"canvas"==a.renderingMode?THREE.CanvasRenderer:THREE.WebGLRenderer;a.renderer=new a.rendererClass;a.renderer.setSize(a.frame.width,a.frame.height);a.$element.get(0).appendChild(a.renderer.domElement)};a.initCamera=function(){a.camera=new THREE.PerspectiveCamera(75,a.frame.width/a.frame.height,150,1E3)};a.initTrackballControl=function(){null==a.trackballControl&&(a.trackballControl=new THREE.TrackballControls(a.camera,a.renderer.domElement),a.trackballControl.rotateSpeed=0.5,a.trackballControl.addEventListener("change",
function(){}),a.on("rendering",function(){a.trackballControl.update()}))};a.render=function(){a.isAnimating&&requestAnimationFrame(a.render);a.trigger("rendering");TWEEN.update();a.renderer.render(a.scene,a.camera)};a.startAnimate=function(){a.isAnimating=!0;a.render()};a.stopAnimate=function(){a.isAnimating=!1};return a.endOfClass(arguments)};